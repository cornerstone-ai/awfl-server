name: Deploy SSE Consumer (Cloud Run)

on:
  push:
    branches:
      - main

jobs:
  build_and_deploy_sse_consumer:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    env:
      GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
      GCP_REGION: ${{ vars.GCP_REGION }}
      GCP_WIF_PROVIDER: ${{ vars.GCP_WIF_PROVIDER }}
      GCP_DEPLOY_SA: ${{ vars.GCP_DEPLOY_SA }}
      CLOUD_RUN_RUNTIME_SA: ${{ vars.CLOUD_RUN_RUNTIME_SA }}
      CLOUD_RUN_SSE_CONSUMER_SERVICE: ${{ vars.CLOUD_RUN_SSE_CONSUMER_SERVICE }}
      SSE_BUCKET: ${{ vars.SSE_BUCKET }}
      CLOUDSDK_CORE_DISABLE_PROMPTS: '1'
      CLOUDSDK_COMPONENT_MANAGER_DISABLE_UPDATE_CHECK: '1'

    steps:
      - uses: actions/checkout@v4

      - name: Load env from .github/actions-variables.json (if present)
        run: |
          set -euo pipefail
          FILE=".github/actions-variables.json"
          if [ -f "$FILE" ]; then
            echo "Loading variables from $FILE"
            jq -r 'to_entries[] | [.key, .value] | @tsv' "$FILE" | while IFS=$'\t' read -r key val; do
              printf '%s=%s\n' "$key" "$val" >> "$GITHUB_ENV"
            done
          else
            echo "No $FILE found; using repository Variables"
          fi

      - name: Authenticate to Google Cloud (WIF/OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.GCP_WIF_PROVIDER }}
          service_account: ${{ env.GCP_DEPLOY_SA }}
          token_format: access_token

      - name: Setup gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Configure gcloud
        run: |
          gcloud config set project "${GCP_PROJECT_ID}"
          gcloud config set run/region "${GCP_REGION}"

      - name: Configure Docker auth for Artifact Registry
        run: |
          gcloud auth configure-docker "${GCP_REGION}-docker.pkg.dev" --quiet

      - name: Build and push image (cloud/sse-consumer)
        id: image
        run: |
          set -euo pipefail
          IMAGE_URI="${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/app/sse-consumer:${GITHUB_SHA}"
          echo "IMAGE_URI=${IMAGE_URI}" >> "$GITHUB_OUTPUT"
          docker build -t "${IMAGE_URI}" cloud/sse-consumer
          docker push "${IMAGE_URI}"

      - name: Compute mount flags for Cloud Storage volume
        id: mount
        run: |
          if [[ -n "${SSE_BUCKET}" ]]; then
            echo "MOUNT_FLAGS=--mount=type=cloud-storage,source=${SSE_BUCKET},target=/mnt/work" >> "$GITHUB_OUTPUT"
          else
            echo "SSE_BUCKET not configured; deploying without volume mount (service may not function)"
            echo "MOUNT_FLAGS=" >> "$GITHUB_OUTPUT"
          fi

      - name: Deploy SSE consumer (auth-required)
        run: |
          gcloud run deploy "${CLOUD_RUN_SSE_CONSUMER_SERVICE}" \
            --quiet \
            --region="${GCP_REGION}" \
            --image="${{ steps.image.outputs.IMAGE_URI }}" \
            --service-account="${CLOUD_RUN_RUNTIME_SA}" \
            --no-allow-unauthenticated \
            --timeout=3600 \
            --set-env-vars="NODE_ENV=production,DISABLE_GCSFUSE=1,WORK_ROOT=/mnt/work" \
            ${{ steps.mount.outputs.MOUNT_FLAGS }}

      - name: Output service URL
        run: |
          gcloud run services describe "${CLOUD_RUN_SSE_CONSUMER_SERVICE}" --region="${GCP_REGION}" --format='value(status.url)'
