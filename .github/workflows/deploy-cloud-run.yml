name: Deploy to Cloud Run on Merge

on:
  push:
    branches:
      - main

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    env:
      # Default to repository variables; will be overridden by JSON if present
      GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
      GCP_REGION: ${{ vars.GCP_REGION }}
      GCP_WIF_PROVIDER: ${{ vars.GCP_WIF_PROVIDER }}
      GCP_DEPLOY_SA: ${{ vars.GCP_DEPLOY_SA }}
      CLOUD_RUN_RUNTIME_SA: ${{ vars.CLOUD_RUN_RUNTIME_SA }}
      CLOUD_RUN_API_SERVICE: ${{ vars.CLOUD_RUN_API_SERVICE }}
      CLOUD_RUN_JOBS_SERVICE: ${{ vars.CLOUD_RUN_JOBS_SERVICE }}

    steps:
      - uses: actions/checkout@v4

      - name: Load env from .github/actions-variables.json (if present)
        run: |
          set -euo pipefail
          FILE=".github/actions-variables.json"
          if [ -f "$FILE" ]; then
            echo "Loading variables from $FILE"
            jq -r 'to_entries[] | [.key, .value] | @tsv' "$FILE" | while IFS=$'\t' read -r key val; do
              printf '%s=%s\n' "$key" "$val" >> "$GITHUB_ENV"
            done
          else
            echo "No $FILE found; using repository Variables"
          fi

      - name: Authenticate to Google Cloud (WIF/OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.GCP_WIF_PROVIDER }}
          service_account: ${{ env.GCP_DEPLOY_SA }}
          token_format: access_token

      - name: Setup gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Configure gcloud
        run: |
          gcloud config set project "${GCP_PROJECT_ID}"
          gcloud config set run/region "${GCP_REGION}"

      # Build --set-secrets flag from secrets.txt (Secret Manager keys listed one per line)
      - name: Build --set-secrets flag from secrets.txt
        id: secrets
        run: |
          # Cloud Run expects ENV=SECRET:VERSION (optionally :PROJECT for cross-project).
          # Using same-project secrets, so we omit the projects/... path used by Cloud Functions.
          if [[ -f secrets.txt ]]; then
            secret_list=$(grep -vE '^\s*#' secrets.txt | grep -vE '^\s*$' | awk '{print $1"="$1":latest"}' | paste -sd "," -)
            if [[ -n "${secret_list}" ]]; then
              echo "SECRET_FLAGS=--set-secrets=${secret_list}" >> $GITHUB_OUTPUT
            else
              echo "SECRET_FLAGS=" >> $GITHUB_OUTPUT
            fi
          else
            echo "secrets.txt not found; continuing without --set-secrets"
            echo "SECRET_FLAGS=" >> $GITHUB_OUTPUT
          fi

      # Switch to image-based deploys (no GCS staging bucket required)
      - name: Configure Docker auth for Artifact Registry
        run: |
          gcloud auth configure-docker "${GCP_REGION}-docker.pkg.dev" --quiet

      - name: Build and push image to Artifact Registry
        id: image
        run: |
          set -euo pipefail
          IMAGE_URI="${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/app/api:${GITHUB_SHA}"
          echo "IMAGE_URI=${IMAGE_URI}" >> "$GITHUB_OUTPUT"
          docker build -t "${IMAGE_URI}" .
          docker push "${IMAGE_URI}"

      - name: Deploy API service (public)
        run: |
          gcloud run deploy "${CLOUD_RUN_API_SERVICE}" \
            --region="${GCP_REGION}" \
            --image="${{ steps.image.outputs.IMAGE_URI }}" \
            --service-account="${CLOUD_RUN_RUNTIME_SA}" \
            --allow-unauthenticated \
            --set-env-vars="NODE_ENV=production,SERVICE_TARGET=start:api,GCP_PROJECT=${GCP_PROJECT_ID},ALLOW_SKIP_AUTH=0,BASE_URL=https://jobs.awfl.us" \
            ${{ steps.secrets.outputs.SECRET_FLAGS }}

      - name: Deploy Jobs service (auth-required)
        run: |
          gcloud run deploy "${CLOUD_RUN_JOBS_SERVICE}" \
            --region="${GCP_REGION}" \
            --image="${{ steps.image.outputs.IMAGE_URI }}" \
            --service-account="${CLOUD_RUN_RUNTIME_SA}" \
            --no-allow-unauthenticated \
            --set-env-vars="NODE_ENV=production,SERVICE_TARGET=start:jobs,GCP_PROJECT=${GCP_PROJECT_ID},ALLOW_SKIP_AUTH=0,BASE_URL=https://jobs.awfl.us" \
            ${{ steps.secrets.outputs.SECRET_FLAGS }}

# Notes:
# - This workflow now uses image-based Cloud Run deploys (no Cloud Build staging bucket),
#   which avoids the storage.buckets.create permission requirement.
# - Ensure `infra` is applied so the Artifact Registry repo `app` exists and IAM bindings are in place.
# - The same image is deployed to both services; SERVICE_TARGET selects the entrypoint at runtime.
